import * as MidiPlayer from "midi-player-js";
import * as _ from 'lodash';
import { Instrument } from "./Instrument";
import { IMidiEvent } from "./IMidiEvent";


const midifile = "data:@file/midi;base64,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";


export class WerckmeisterMidiPlayer {
    audioContext: AudioContext;
    instrument: Instrument;
    public async init(): Promise<void> {
        try {
            this.audioContext = new AudioContext();
            this.instrument = new Instrument('marimba', this.audioContext);
            await this.instrument.load();

            const instrument2 = new Instrument('marimba', this.audioContext);
            await instrument2.load();

            this.play();
        } catch (ex) {
            console.log(ex)
        }
    }


    private preprocessEvents(events: MidiPlayer.Event[]) {
        const programChanges = _.chain(events)
            .flatten()
            .filter(x => x.name === 'Program Change')
            .value();
        console.log(programChanges);
    }

    play() {
        const midiPlayer = new MidiPlayer.Player();
        midiPlayer.on('midiEvent', (event: IMidiEvent) => {
            if (event.name !== 'Note on') {
                return;
            }
            this.instrument.noteOn(event);
        });
        midiPlayer.loadDataUri(midifile);
        this.preprocessEvents(midiPlayer.getEvents());
        midiPlayer.play();
    }
}