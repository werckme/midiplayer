import * as MidiPlayer from "midi-player-js";
import * as _ from 'lodash';
import { Instrument } from "./Instrument";
import { IMidiEvent, MidiEventNames } from "./IMidiEvent";
import { forEach } from "lodash";
import { GetInstrumentNameForPc, InstrumentNames } from "./GM";


const enio = "data:@file/midi;base64,TVRoZAAAAAYAAQAEAfRNVHJrAAAAGwD/AwxtYXN0ZXIgdHJhY2sA/1EDBwriAP8vAE1UcmsAAAAEAP8vAE1UcmsAAAYFAP8DBXBpYW5vAP9/CQFNeURldmljZQCxAAAAsQt/ALEKPwDBAwCRJHODdIEkAACRNFkAkTdZAJE7WYN0gTQAAIE3AACBOwAAkTRZAJE3WQCRO1mDdIE0AACBNwAAgTsAAJEfZoN0gR8AAJEkc4N0gSQAAJE0WQCRN1kAkTtZg3SBNAAAgTcAAIE7AACRNFkAkTdZAJE7WYN0gTQAAIE3AACBOwAAkR9mg3SBHwAAkSRzg3SBJAAAkTRZAJE3WQCRO1mDdIE0AACBNwAAgTsAAJE0WQCRN1kAkTtZg3SBNAAAgTcAAIE7AACRH2aDdIEfAACRJHODdIEkAACRNFkAkTdZAJE7WYN0gTQAAIE3AACBOwAAkTRZAJE3WQCRO1mDdIE0AACBNwAAgTsAAJEfZoN0gR8AAJEkc4N0gSQAAJE0WQCRN1kAkTtZg3SBNAAAgTcAAIE7AACRNFkAkTdZAJE7WYN0gTQAAIE3AACBOwAAkR9mg3SBHwAAkSRzg3SBJAAAkTRZAJE3WQCRO1mDdIE0AACBNwAAgTsAAJE0WQCRN1kAkTtZg3SBNAAAgTcAAIE7AACRH2aDdIEfAACRJ3ODdIEnAACRN1kAkTpZAJE+WYN0gTcAAIE6AACBPgAAkTdZAJE6WQCRPlmDdIE3AACBOgAAgT4AAJEiZoN0gSIAAJEnc4N0gScAAJE3WQCROlkAkT5Zg3SBNwAAgToAAIE+AACRN1kAkTpZAJE+WYN0gTcAAIE6AACBPgAAkSJmg3SBIgAAkSdzg3SBJwAAkTdZAJE6WQCRPlmDdIE3AACBOgAAgT4AAJE3WQCROlkAkT5Zg3SBNwAAgToAAIE+AACRImaDdIEiAACRJ3ODdIEnAACRN1kAkTpZAJE+WYN0gTcAAIE6AACBPgAAkTdZAJE6WQCRPlmDdIE3AACBOgAAgT4AAJEiZoN0gSIAAJEsc4N0gSwAAJE8WQCRP1kAkUNZg3SBPAAAgT8AAIFDAACRPFkAkT9ZAJFDWYN0gTwAAIE/AACBQwAAkSdmg3SBJwAAkSxzg3SBLAAAkTxZAJE/WQCRQ1mDdIE8AACBPwAAgUMAAJE8WQCRP1kAkUNZg3SBPAAAgT8AAIFDAACRJ2aDdIEnAACRLHODdIEsAACRPFkAkT9ZAJFDWYN0gTwAAIE/AACBQwAAkTxZAJE/WQCRQ1mDdIE8AACBPwAAgUMAAJEnZoN0gScAAJEsc4N0gSwAAJE8WQCRP1kAkUNZg3SBPAAAgT8AAIFDAACRPFkAkT9ZAJFDWYN0gTwAAIE/AACBQwAAkSdmg3SBJwAAkStzg3SBKwAAkTtZAJE+WQCRQVmDdIE7AACBPgAAgUEAAJE7WQCRPlkAkUFZg3SBOwAAgT4AAIFBAACRJmaDdIEmAACRK3ODdIErAACRO1kAkT5ZAJFBWYN0gTsAAIE+AACBQQAAkTtZAJE+WQCRQVmDdIE7AACBPgAAgUEAAJEmZoN0gSYAAJErc4N0gSsAAJE7WQCRPlkAkUFZg3SBOwAAgT4AAIFBAACRO1kAkT5ZAJFBWYN0gTsAAIE+AACBQQAAkSZmg3SBJgAAkStzg3SBKwAAkTtZAJE+WQCRQVmDdIE7AACBPgAAgUEAAJE7WQCRPlkAkUFZg3SBOwAAgT4AAIFBAACRJmaDdIEmAACRK3ODdIErAACRO1kAkT5ZAJFBWYN0gTsAAIE+AACBQQAAkTtZAJE+WQCRQVmDdIE7AACBPgAAgUEAAJEmZoN0gSYAAJEkc4N0gSQAAJE0WQCRN1mDdIE0AACBNwAAkTRZAJE3WYN0gTQAAIE3AACRH2aDdIEfAACRJHODdIEkAACRNFkAkTdZg3SBNAAAgTcAAJE0WQCRN1mDdIE0AACBNwAAkR9mg3SBHwAAkSRzg3SBJAAAkTNZAJE3WYN0gTMAAIE3AACRM1kAkTdZg3SBMwAAgTcAAJEfZoN0gR8AAJEkc4N0gSQAAJEzWQCRN1mDdIEzAACBNwAAkTNZAJE3WYN0gTMAAIE3AACRH2aDdIEfAAD/LwBNVHJrAAACGwD/AwVwaWFubwD/fwkBTXlEZXZpY2UAsQAAALELfwCxCj8AwQOfIJE8c4dogTwAAJE+c4dogT4AAJFAc49QgUAAh2iRPHODdIE8AACRPnODdIE+AACRQHODdIFAAACRQHODdIFAAACRQ3ODdIFDAACRPHODdIE8AACRP3OHaIE/AACRP3ODdIE/AACRPnODdIE+AACRPHOHaIE8AACRRnODdIFGAACRRXODdIFFAACRQ3OHaIFDAACRQ3ODdIFDAACRRXODdIFFAACRRnODdIFGAACRSHODdIFIAACRRnODdIFGAACRRXODdIFFAACRRHOHaIFEAACRRHODdIFEAACRRnODdIFGAACRSHODdIFIAACROHODdIE4AACROHODdIE4AACROnODdJE8c4N0gToAAIE8AACRRHODdIFEAACRRHODdIFEAACRRnODdIFGAACRSHODdIFIAACRSHODdIFIAACRS3OBeoFLAACRSnOBeoFKAACRSHOBeoFIAACRSnOBeoFKAACRR3OHaIFHAACRO3OHaIE7AJNEkUdzg3SBRwAAkUdzg3SBRwAAkUhzg3SBSAAAkUpzg3SBSgAAkUpzg3SBSgAAkUpzg3SBSgAAkUpzg3SBSgAAkUpzg3SBSgAAkUpzg3SBSgAAkUxzgXqBTAAAkUpzgXqBSgAAkUhzgXqBSAAAkUdzgXqBRwAAkUhzj1CBSAAA/y8A";
const blackpages = "data:@file/midi;base64,TVRoZAAAAAYAAQAGAfRNVHJrAAAAGwD/AwxtYXN0ZXIgdHJhY2sA/1EDD0JAAP8vAE1UcmsAAAAEAP8vAE1UcmsAAAJEAP8DBGJhc3MA/38JAU15RGV2aWNlALIAAACyC1IAsgo/AMIaAJIrWYtcgisAAJImWYN0giYAAJIuWYtcgi4AAJIpWYN0gikAAJIrWYtcgisAAJImWYN0giYAAJIuWYtcgi4AAJIpWYN0gikAAJIrWYtcgisAAJImWYN0giYAAJIuWYtcgi4AAJIpWYN0gikAAJIrWYtcgisAAJImWYN0giYAAJIuWYtcgi4AAJIpWYN0gikAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJImWYtcgiYAAJIhWYN0giEAAJIqWYtcgioAAJIlWYN0giUAAJIqWYtcgioAAJIlWYN0giUAAJIuWYtcgi4AAJIpWYN0gikAAJIrWYtcgisAAJImWYN0giYAAJIuWYtcgi4AAJIpWYN0gikAAJIrWYtcgisAAJImWYN0giYAAJIuWYtcgi4AAJIpWYN0gikAAJIkWYtcgiQAAJIfWYN0gh8AAJIkWYtcgiQAAJIfWYN0gh8AAJIkWYtcgiQAAJIfWYN0gh8AAJIkWYtcgiQAAJIfWYN0gh8AAJIkWYtcgiQAAJIfWYN0gh8AAJIlWYdogiUAAJIqWYdogioAAJIsWYtcgiwAAJInWYN0gicAAP8vAE1UcmsAAATZAP8DBWRydW1zAP9/CQFNeURldmljZQC5AAAAuQt/ALkKPwDJAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmBeokqAIF6mSpZgXqJKgCBepkqWYF6iSoAgXqZKlmB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";
const midifile = enio;
const percussionInstrumentName = "percussion";
const percussionMidiChannel = 10;

export class WerckmeisterMidiPlayer {
    audioContext: AudioContext;
    instruments = new Map<number, Instrument>();
    percussion: Instrument|null;
    public async init(): Promise<void> {
        try {
            this.audioContext = new AudioContext();
            this.play();
        } catch (ex) {
            console.log(ex)
        }
    }


    private async preprocessEvents(events: MidiPlayer.Event[]) {
        let neededInstruments = _.chain(events)
            .flatten()
            .filter(x => x.name === 'Program Change')
            .map(x => GetInstrumentNameForPc(x.value))
            .uniq()
            .filter(x => !!x)
            .value();
        const needsPercussion = _.chain(events)
            .flatten()
            .some(x => x.channel === percussionMidiChannel)
            .value();
        if (needsPercussion) {
            neededInstruments.push(percussionInstrumentName);
            this.percussion = new Instrument(percussionInstrumentName, this.audioContext);
        }
        for(const instrumentName of neededInstruments) {
            await Instrument.loadSamples(instrumentName, this.audioContext);
        }
    }

    noteOn(event: IMidiEvent) {
        let instrument: Instrument;
        if (event.channel === percussionMidiChannel) {
            instrument = this.percussion;
        } else {
            instrument = this.instruments.get(event.track);
        }
        instrument.noteOn(event);
    }

    ProgramChange(event: IMidiEvent) {
        const instrumentName = GetInstrumentNameForPc(event.value);
        const instrument = new Instrument(instrumentName, this.audioContext);
        this.instruments.set(event.track, instrument);
    }

    async play() {
        const midiPlayer = new MidiPlayer.Player();
        midiPlayer.on('midiEvent', (event: IMidiEvent) => {
            switch(event.name) {
                case MidiEventNames.NoteOn: return this.noteOn(event);
                case MidiEventNames.Pc: return this.ProgramChange(event);
            }
        });
        midiPlayer.loadDataUri(midifile);
        await this.preprocessEvents(midiPlayer.getEvents());
        midiPlayer.play();
    }
}